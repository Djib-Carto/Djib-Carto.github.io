<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Nuages Monde – NASA GIBS</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
:root{
  --panel-w: 360px;
  --gutter: 12px;
  --accent: #0f766e;
}
html,body,#app { height:100%; margin:0; font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
#app { display:grid; grid-template-columns:1fr var(--panel-w); grid-template-rows:auto 1fr; gap:var(--gutter); background:#f3f4f6; }

header.app-header { grid-column:1/-1; display:flex; align-items:center; gap:12px; padding:14px; background:linear-gradient(90deg,#ffffff,#fafafa); border-bottom:1px solid #e6e6e6; box-shadow:0 1px 2px rgba(0,0,0,0.03); }
header.app-header h1 { margin:0; font-size:16px; color:#0f172a; }
header.app-header p { margin:0; color:#475569; font-size:13px; }

#map { grid-column:1/2; grid-row:2/3; height: calc(100% - 16px); margin: 8px; border-radius: 8px; overflow:hidden; box-shadow: 0 6px 18px rgba(15,23,42,0.08); }
aside.panel { grid-column:2/3; grid-row:2/3; margin:8px; background:white; border-radius:10px; padding:12px; box-shadow:0 6px 18px rgba(15,23,42,0.06); display:flex; flex-direction:column; gap:10px; overflow:auto; }

.section-title { font-weight:600; font-size:13px; color:#0f172a; margin-bottom:6px; display:flex; justify-content:space-between; align-items:center; }
.controls-row { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
button.control { background:var(--accent); color:white; border:0; padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
button.ghost { background:transparent; border:1px solid #e6e6e6; color:#0f172a; padding:8px 10px; border-radius:8px; cursor:pointer; }
input[type="range"] { width:100%; }
.small { font-size:12px; color:#475569; }

@media (max-width:900px){
  #app{grid-template-columns:1fr;grid-template-rows:auto 1fr auto;}
  aside.panel{grid-column:1/-1;grid-row:3/4;margin:8px;}
  #map{grid-column:1/-1;grid-row:2/3;margin:8px;height:60vh;}
}
</style>
</head>
<body>
<div id="app">
<header class="app-header">
  <div style="display:flex;flex-direction:column">
    <h1>Nuages Monde – NASA GIBS</h1>
    <p>Source: NASA GIBS WMS — couche <code>MODIS_Terra_CorrectedReflectance_TrueColor</code></p>
  </div>
</header>

<div id="map"></div>

<aside class="panel">
  <div>
    <div class="section-title"><span>Contrôles temporels</span></div>

    <div class="row" style="justify-content:space-between">
      <div style="flex:1" class="controls-row">
        <button id="btnPlay" class="control">▶️ Lecture</button>
        <button id="btnPause" class="ghost">⏸️ Pause</button>
        <button id="btnStepBack" class="ghost">◀️</button>
        <button id="btnStepFwd" class="ghost">▶️</button>
      </div>
      <div style="width:120px;">
        <label class="small">Vitesse</label>
        <select id="speed" style="width:100%; padding:6px; border-radius:6px; border:1px solid #e6e6e6;">
          <option value="1500">Lente</option>
          <option value="1000" selected>Normale</option>
          <option value="600">Rapide</option>
          <option value="300">Très rapide</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label class="small">Sélection manuelle</label>
      <input id="datetime" type="datetime-local" style="width:100%; padding:8px; border-radius:6px; border:1px solid #e6e6e6;">
    </div>

    <div style="margin-top:10px;">
      <label class="small">Curseur temporel</label>
      <input id="timeSlider" type="range" min="0" max="0" step="1" value="0">
      <div class="row" style="justify-content:space-between; font-size:12px; color:#64748b;">
        <div id="timeStartLabel">—</div>
        <div id="timeCurrentLabel">—</div>
        <div id="timeEndLabel">—</div>
      </div>
    </div>

    <hr style="margin:8px 0;border:none;height:1px;background:#f1f5f9;">

    <div class="section-title"><span>Affichage</span></div>
    <label class="small">Opacité</label>
    <input id="opacity" type="range" min="0" max="1" step="0.05" value="1">

  </div>
</aside>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
/* ------------------ Config temporelle ------------------ */
const TIME_START = new Date("2000-03-31T05:00:00Z"); // début 2000
const TIME_END   = new Date(); // par défaut aujourd'hui
const STEP_MIN   = 15; // minutes

function buildTimes(start,end,stepMin){
  const arr=[]; let t=new Date(start);
  while(t<=end){ arr.push(new Date(t)); t=new Date(t.getTime()+stepMin*60000); }
  return arr;
}
const times=buildTimes(TIME_START,TIME_END,STEP_MIN);

function isoUTC(dt){return dt.toISOString().replace('.000Z','Z');}
function toLocalDatetimeInputValue(dt){ const local=new Date(dt.getTime()-dt.getTimezoneOffset()*60000); return local.toISOString().slice(0,16); }
function fromDatetimeInputToUTC(val){ const local=new Date(val); return new Date(local.getTime()+local.getTimezoneOffset()*60000); }

/* ------------------ Carte & couches ------------------ */
const map=L.map('map',{preferCanvas:true}).setView([0,20],3.5);
const baseOSM=L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',{ attribution:'&copy; CARTO & OSM' }).addTo(map);
const WMS_URL='https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi';
const LAYER_NAME='MODIS_Terra_CorrectedReflectance_TrueColor';

function createWMSLayer(timeISO){
  return L.tileLayer.wms(WMS_URL,{
    layers:LAYER_NAME,
    format:'image/png',
    transparent:true,
    time:timeISO,
    opacity:parseFloat(document.getElementById('opacity').value)
  });
}

let index=0;
let wms=createWMSLayer(isoUTC(times[index]));
wms.addTo(map);

/* ------------------ UI ------------------ */
const btnPlay=document.getElementById('btnPlay');
const btnPause=document.getElementById('btnPause');
const btnStepBack=document.getElementById('btnStepBack');
const btnStepFwd=document.getElementById('btnStepFwd');
const speedSel=document.getElementById('speed');
const datetimeInput=document.getElementById('datetime');
const slider=document.getElementById('timeSlider');
const labelStart=document.getElementById('timeStartLabel');
const labelEnd=document.getElementById('timeEndLabel');
const labelCurrent=document.getElementById('timeCurrentLabel');
const opacityInput=document.getElementById('opacity');

slider.max=times.length-1; slider.value=index;
labelStart.textContent=isoUTC(times[0]).slice(0,16).replace('T',' ');
labelEnd.textContent=isoUTC(times[times.length-1]).slice(0,16).replace('T',' ');
labelCurrent.textContent=isoUTC(times[index]).slice(0,16).replace('T',' ');
datetimeInput.value=toLocalDatetimeInputValue(times[index]);

function updateUI(){ slider.value=index; labelCurrent.textContent=isoUTC(times[index]).slice(0,16).replace('T',' '); datetimeInput.value=toLocalDatetimeInputValue(times[index]); }
function setTimeIndex(newIndex){ newIndex=Math.max(0,Math.min(times.length-1,newIndex)); index=newIndex; if(wms) map.removeLayer(wms); wms=createWMSLayer(isoUTC(times[index])); wms.addTo(map); updateUI(); }

btnStepBack.addEventListener('click',()=>setTimeIndex(index-1));
btnStepFwd.addEventListener('click',()=>setTimeIndex(index+1));
slider.addEventListener('input',()=>setTimeIndex(parseInt(slider.value,10)));

datetimeInput.addEventListener('change',(e)=>{
  const utc=fromDatetimeInputToUTC(e.target.value);
  const snapped=new Date(Math.round((utc.getTime()-TIME_START.getTime())/(STEP_MIN*60000))*(STEP_MIN*60000)+TIME_START.getTime());
  const idx=Math.round((snapped.getTime()-TIME_START.getTime())/(STEP_MIN*60000));
  setTimeIndex(idx);
});

opacityInput.addEventListener('input',()=>{ if(wms) wms.setOpacity(parseFloat(opacityInput.value)); });

let intervalId=null;
btnPlay.addEventListener('click',()=>{
  if(intervalId) return;
  const speed=parseInt(speedSel.value,10);
  intervalId=setInterval(()=>{ setTimeIndex((index+1)%times.length); },speed);
});
btnPause.addEventListener('click',()=>{
  if(intervalId){ clearInterval(intervalId); intervalId=null; }
});

setTimeIndex(index);
</script>
</body>
</html>
